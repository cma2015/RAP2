<tool id="matrix_factorization" name="Matrix factorization">
  <description>
  </description>
  <requirements>
      <requirement type="package" version="3.4.2">R</requirement>
      <requirement type="package" version="1.2.0">getopt</requirement>
  </requirements>

  <command>	
	Rscript /galaxy/tools/TAMF/matrix_factorization.R

	--input1
	#if $Decomposition.decompose in ["4"]:
		$am
	#else:		
		$geneExp
	#end if			
	--input2
	#if $Decomposition.decompose in ["1"]:
		$Decomposition.cpu
	#elif $Decomposition.decompose in ["4"]:
		$pm
	#else		
		1
	#end if			
	--input3
		$Decomposition.decompose		
	--output1 $amplitude
	--output2 $pattern 
	--pdf1
	     $statistics ;
	

</command>

  <inputs>
	<param name="geneExp" type="data" label="prepared gene expression matrix" />	
	<conditional name="Decomposition">
			<param name="decompose" type="select" label="decomposition options">
				<option value="1">PCA</option>
				<option value="2">ICA</option>
				<option value="3">NMF</option>
				<option value="4">User-specific</option>
			</param>
			<when value="1">	
				<param name="cpu" type="text" value="2" label="cup number" />
			</when>
			<when value="4">	
				<param name="am" type="data" label="amplitude matrix" />
				<param name="pm" type="data" label="pattern matrix" />
			</when>
	</conditional>	
	
  </inputs>  
	<stdio><exit_code range="1:" level="fatal" description="Error Running build RAP2 model"/></stdio>
  <outputs>	
	<data name="amplitude" format="tabular" label="amplitude matrix" help="molecular relationships" />
	<data name="pattern" format="tabular" label="pattern matrix" help="sample relationships" />
	<data name="statistics" format="pdf" label="statistics analysis of the decomposition" help="statistics analysis of the decomposition" >
		<filter>Decomposition['decompose'] == '1' or Decomposition['decompose'] == '2' or Decomposition['decompose'] == '3'</filter>
	</data>
  </outputs>


    <help>
.. class:: infomark

**What it does**

*Matrix factorization* is used to decompose the prepared gene expression matrix through three algorithms:

* **PCA**: principal component analysis, orthogonal

* **ICA**: independent component analysis, independent

* **NMF**: non-negative matrix factorization, dependent

* **User-specific**: upload amplitude and pattern matrix decomposed through his personal algorithm


-------------

.. class:: infomark

**Inputs**

**decomposition options** - Currently, we provide four sub-functions to do the decomposition:

* **PCA**: Orthogonal decomposition (F=AX), the user should input the cpu number (default is 2) to parallelly compute. Then, the optimal components will be figured out based on the internal consistency alpha coefficient


* **ICA**: Independent decomposition (X=SM+E). Then, the optimal components will be figured out based on the inflection point of rate of the residue decline

* **NMF**: Dependent decomposition (V=WH+E). Then, the optimal components will be figured out based on the inflection point of the residue decline

* **User-specific**: upload amplitude and pattern matrix decomposed through his personal algorithm through *Upload File* tool the **Get Data** section, the choose it through the **History** panel


-------------


.. class:: infomark

**Outputs**

**statistics analysis of the decomposition**

.. image:: static/decompose_statistics.jpg
   :width: 500 px
   :scale: 120 %   
   :align: center

| 

**amplitude matrix**

.. csv-table:: 
   :header: " ", "NC1", "NC2", "NC3", "NC4"
   :widths: 15, 10, 10, 10, 10

   "AT1G01010", 0.080, -0.889, 1.504, 2.029
   "AT1G01030", 1.338, 0.729, -0.113, -0.049
   "AT1G01040", -0.465, -0.229, -0.247, -0.206
   "AT1G01050", -1.674, 0.036, -0.047, -0.494

|



**pattern matrix**

.. csv-table:: 
   :header: " ", "NC1", "NC2", "NC3", "NC4"
   :widths: 15, 10, 10, 10, 10

   "Sample1", -2.081, 0.663, -0.594, -0.711
   "Sample2", -2.114, 0.711, -0.597, -0.757
   "Sample3", -2.189, 0.630, -0.617, -0.745
   "Sample4", -2.185, 0.671, -0.603, -0.719

|

-------------

.. class:: infomark

**Citation**



-------------

.. class:: warningmark

**Note**

* The elapsed time increase with increase of the data size.

* The uploaded personal amplitude and pattern matrix must obey the format in the **Output** section by which the rows represent the genes or samples and the columns represent the number of components.

* To make statistical significant, the **minimum** number of component is set to **3**.

-------------

|


  </help>



</tool>
