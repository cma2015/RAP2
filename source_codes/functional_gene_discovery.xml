<tool id="functional_gene_discovery" name="Functional gene discovery">
  <description>
  </description>
  <requirements>
      <requirement type="package" version="3.4.2">R</requirement>
      <requirement type="package" version="1.2.0">getopt</requirement>
  </requirements>

  <command>	
	 Rscript /galaxy/tools/TAMF/functional_gene_discovery.R

	--input1
		 $amplitude 
	--input2
		$Discovery.discovery
	--input3
			$cpu
	#if	$Discovery.discovery in ["1"]:	
				
		--input4
			$Discovery.geneset
		--pdf1
			$AUSR
		--output1
			$candidates
	#end if	


	#if $Discovery.discovery in ["2"]:

		--input5
			$Discovery.GWAS
		--input13
			$Discovery.pvalue
		--input6
			$Discovery.Construction.construction

		#if	$Discovery.Construction.construction in ["1"]:	

		#elif $Discovery.Construction.construction in ["2"]:	
			--input7
				$Discovery.Construction.construct	
			--input14
				$Discovery.Construction.annotaGene		
		#else			
			--input12
				$Discovery.Construction.evidence
			--input9
				$Discovery.Construction.Calculate.calculate
			#if $Discovery.Construction.Calculate.calculate in ["1"]:	
				--input10
					$Discovery.Construction.Calculate.annotaSelf
				--input14
					$Discovery.Construction.Calculate.annotaGene
			#else
				--input11
					$Discovery.Construction.Calculate.annotaFetch
			#end if
			
			--output5
				$gene2geneset
			--output6
				$functionalterm			
		#end if

		--output2
			$enrichment
		--output3
			$prioritize
		--output4
			$filtersig
		--pdf2
			$filtersiggene
		--pdf3
			$manhattan
	#end if




;
	
</command>
  <inputs>
	<param name="amplitude" type="data" label="amplitude matrix" />	
	<param name="cpu" type="text" value="2" label="cup number" />
	<conditional name="Discovery">	
		<param name="discovery" type="select" label="functional gene discovery options" >
				<option value="1">New candidates of a gene set</option>
				<option value="2">Biological interpretation of GWAS result</option>
		</param>
		<when value="1">
			
			<param name="geneset" type="text" value="AT1G76670,AT4G32410,AT4G39350,AT5G05170,AT5G64740" area="true" label="seed genes (separated by comma or new line)" />
		</when>
		<when value="2">
			<param name="GWAS" type="data" label="upload the SNPMapGene GWAS result" />	
			<param name="pvalue" type="text" value="5" label="the significant level (default is 1.0e-05)" />	
			<conditional name="Construction">					
				<param name="construction" type="select" label="functional gene probabilities construction" >
					<option value="1">Default (Arabidopsis thaliana genes (TAIR10))</option>
					<option value="2">User-specific</option>
								
				</param>
				<when value="2">
					<param name="construct" type="data" label="upload the construction of functional gene probabilities" >						
					</param>
					<param name="annotaGene" type="data" label="upload the gene description file" />	
				</when>
				<when value="3">					
					<conditional name="Calculate">
						<param name="calculate" type="select" label="functional gene annotation" >
							<option value="2">fetch from EnsemblPlants</option>
							<option value="1">upload</option>
							
						</param>
						<when value="1">
							<param name="annotaSelf" type="data" label="upload the functional gene annotation file" />	
							<param name="annotaGene" type="data" label="upload the gene description file" />									
						</when>
						<when value="2">
							<param name="annotaFetch" type="select" label="fetch the functional gene annotation file from EnsemblPlants" >
								<option value="1">Aegilops tauschii genes (ASM34733v1)</option>
								<option value="2">Amborella trichopoda genes (AMTR1.0)</option>
								<option value="3">Arabidopsis lyrata genes (v.1.0)</option>
								<option value="4" selected="true">Arabidopsis thaliana genes (TAIR10)</option>
								<option value="5">Beta vulgaris genes (RefBeet-1.2.2)</option>
								<option value="6">Brachypodium distachyon genes (Brachypodium_distachyon_v3.0)</option>
								<option value="7">Brassica napus genes (AST_PRJEB5043_v1)</option>
								<option value="8">Brassica oleracea genes (BOL)</option>
								<option value="9">Brassica rapa genes (Brapa_1.0)</option>
								<option value="10">Chlamydomonas reinhardtii genes (Chlamydomonas_reinhardtii_v5.5)</option>
								<option value="11">Chondrus crispus genes (ASM35022v2)</option>
								<option value="12">Corchorus capsularis genes (CCACVL1_1.0)</option>
								<option value="13">Cucumis sativus genes (ASM407v2)</option>
								<option value="14">Cyanidioschyzon merolae genes (ASM9120v1)</option>
								<option value="15">Daucus carota genes (ASM162521v1)</option>
								<option value="16">Dioscorea rotundata genes (TDr96_F1_Pseudo_Chromosome_v1.0)</option>
								<option value="17">Galdieria sulphuraria genes (ASM34128v1)</option>
								<option value="18">Glycine max genes (Glycine_max_v2.0)</option>
								<option value="19">Gossypium raimondii genes (Graimondii2_0)</option>
								<option value="20">Helianthus annuus genes (HanXRQr1.0)</option>
								<option value="21">Hordeum vulgare genes (IBSC v2)</option>
								<option value="22">Leersia perrieri genes (Lperr_V1.4)</option>
								<option value="23">Lupinus angustifolius genes (LupAngTanjil_v1.0)</option>
								<option value="24">Manihot esculenta genes (Manihot esculenta v6)</option>
								<option value="25">Medicago truncatula genes (MedtrA17_4.0)</option>
								<option value="26">Musa acuminata genes (ASM31385v1)</option>
								<option value="27">Nicotiana attenuata genes (NIATTr2)</option>
								<option value="28">Oryza barthii genes (O.barthii_v1)</option>
								<option value="29">Oryza brachyantha genes (Oryza_brachyantha.v1.4b)</option>
								<option value="30">Oryza glaberrima genes (Oryza_glaberrima_V1)</option>
								<option value="31">Oryza glumipatula genes (Oryza_glumaepatula_v1.5)</option>
								<option value="32">Oryza longistaminata genes (O_longistaminata_v1.0)</option>
								<option value="33">Oryza meridionalis genes (Oryza_meridionalis_v1.3)</option>
								<option value="34">Oryza nivara genes (Oryza_nivara_v1.0)</option>
								<option value="35">Oryza punctata genes (Oryza_punctata_v1.2)</option>
								<option value="36">Oryza rufipogon genes (OR_W1943)</option>
								<option value="37">Oryza sativa Indica Group genes (ASM465v1)</option>
								<option value="38">Oryza sativa Japonica Group genes (IRGSP-1.0)</option>
								<option value="39">Ostreococcus lucimarinus genes (ASM9206v1)</option>
								<option value="40">Phaseolus vulgaris genes (PhaVulg1_0)</option>
								<option value="41">Physcomitrella patens genes (Phypa V3)</option>
								<option value="42">Populus trichocarpa genes (Pop_tri_v3)</option>
								<option value="43">Prunus persica genes (Prunus_persica_NCBIv2)</option>
								<option value="44">Selaginella moellendorffii genes (v1.0)</option>
								<option value="45">Setaria italica genes (Setaria_italica_v2.0)</option>
								<option value="46">Solanum lycopersicum genes (SL2.50)</option>
								<option value="47">Solanum tuberosum genes (SolTub_3.0)</option>
								<option value="48">Sorghum bicolor genes (Sorghum_bicolor_NCBIv3)</option>
								<option value="49">Theobroma cacao genes (Theobroma_cacao_20110822)</option>
								<option value="50">Trifolium pratense genes (Trpr)</option>
								<option value="51">Triticum aestivum genes (IWGSC)</option>
								<option value="52">Triticum dicoccoides genes (WEWSeq v.1.0)</option>
								<option value="53">Triticum urartu genes (ASM34745v1)</option>
								<option value="54">Vigna angularis genes (Vigan1.1)</option>
								<option value="55">Vigna radiata genes (Vradiata_ver6)</option>
								<option value="56">Vitis vinifera genes (12X)</option>
								<option value="57">Zea mays genes (B73 RefGen_v4)</option>
							</param>						
						</when>	
							
					</conditional>
					<param name="evidence" type="select" label="evidence code" multiple="true" help="gold standard evidence code">
								<option value="1">IBA</option>
								<option value="2">IC</option>
								<option value="3" selected="true">IDA</option>
								<option value="4">IEA</option>
								<option value="5" selected="true">IEP</option>
								<option value="6" selected="true">IGI</option>
								<option value="7" selected="true">IMP</option>
								<option value="8" selected="true">IPI</option>
								<option value="9">ISA</option>
								<option value="10">ISM</option>
								<option value="11">ISS</option>
								<option value="12">NAS</option>
								<option value="13">ND</option>
								<option value="14">RCA</option>
								<option value="15" selected="true">TAS</option>
					</param>
				</when>
				
		 	
			</conditional>
			
		
		</when>
	</conditional>
  </inputs> 
  <stdio><exit_code range="1:" level="fatal" description="Error"/></stdio> 
 <outputs>	
	
	<data name="AUSR" format="pdf" label="AUSR" help="AUSR plot of the gene set through LOOCV" >
	<filter>Discovery['discovery'] == '1'</filter>
	</data>
	<data name="candidates" format="tabular" label="new candidates" help="new candidates prioritization" >
	<filter>Discovery['discovery'] == '1'</filter>
	</data>

	<data name="enrichment" format="tabular" label="enrichment analysis" help="enrichment analysis of the significant genes above the significant level" >
	<filter>Discovery['discovery'] == '2'</filter>
	</data>
	<data name="prioritize" format="tabular" label="prioritize the potential genes" help="prioritize the potential related genes below the significant level" >
	<filter>Discovery['discovery'] == '2'</filter>
	</data>	
	<data name="filtersig" format="tabular" label="filter false related genes" help="filter false related genes above the significant level" >
	<filter>Discovery['discovery'] == '2'</filter>
	</data>
	<data name="filtersiggene" format="pdf" label="visulization of the filter" help="pheatmap of the significant genes above the significant level" >
	<filter>Discovery['discovery'] == '2'</filter>
	</data>
	<data name="manhattan" format="pdf" label="manhattan plot" help="manhattan plot of the GWAS result" >
			<filter>Discovery['discovery'] == '2'</filter>
	</data>
	
	


  </outputs>


    <help>
.. class:: infomark

**What it does**

*Functional gene discovery* is used to do the functional gene discovery. Currently, we provide two sub-functions:

* new candidates of an interest gene set

* improve the biological interpretation of the GWAS result


-------------

.. class:: infomark

**Inputs**

**amplitude matrix** - generated from the prepared gene expression matrix through **Matrix factorization** tool in the **History** panel
 
  
* .. csv-table:: 
   :header: " ", "NC1", "NC2", "NC3", "NC4"
   :widths: 15, 10, 10, 10, 10

   "AT1G01010", 0.080, -0.889, 1.504, 2.029
   "AT1G01030", 1.338, 0.729, -0.113, -0.049
   "AT1G01040", -0.465, -0.229, -0.247, -0.206
   "AT1G01050", -1.674, 0.036, -0.047, -0.494

|


**cpu number** - the cpu number to parallelly compute

**functional gene discovery options** - Currently, we provide two sub-functions:

* **New candidates of a gene set** - find the new candidates for a gene set, the only need is to input the seed genes (**a set of genes for a function/pathway/phenotype**) in the box:
   
  +-------------+--------------------------------------------------+
  | new line    | comma                                            | 
  +=============+==================================================+
  | | AT1G76670 | AT1G76670,AT4G32410,AT4G39350,AT5G05170,AT5G64740|
  | | AT4G32410 |                                                  |
  | | AT4G39350 |                                                  |
  | | AT5G05170 |                                                  |
  | | AT5G64740 |                                                  |    
  +-------------+--------------------------------------------------+

|

* **Biological interpretation of GWAS result** - gaining biological insight into the GWAS result, the following parameters are need:

  **upload the SNPMapGene GWAS result** - input a transformed GWAS result (**the SNPs map to genes**) data generated from a **csv** format (**internal by comma**) file (the **raw GWAS** data) through an R function `SNPMapGene.R`_

  +----------+-------+----------+-----------+---------+-------------+
  | flag     | Chr   | position | gene      | type    | p           | 
  +==========+=======+==========+===========+=========+=============+
  | Chr1_73  | Chr1  | 73       | AT1G01010 | nearest | 0.6803759   |
  +----------+-------+----------+-----------+---------+-------------+
  | Chr1_92  | Chr1  | 92       | AT1G01010 | nearest | 0.03787863  |
  +----------+-------+----------+-----------+---------+-------------+
  | Chr1_110 | Chr1  | 110      | AT1G01010 | nearest | 0.9668433   |
  +----------+-------+----------+-----------+---------+-------------+
  | Chr1_253 | Chr1  | 253      | AT1G01010 | nearest | 0.8715199   |
  +----------+-------+----------+-----------+---------+-------------+

  |

  **the significant level (default is 1.0e-05)** - the significant level, default is the **1e-05**

  **functional gene probabilities construction** - select the way to obtain the functional gene probabilities construction. Currently, we provide two options:

  * **Default (Arabidopsis thaliana genes (TAIR10))** - default is the pre-calculated construction of the *Arabidopsis thaliana*

  * +--------------+--------------+--------------+
    | `GO:0000003` | `GO:0000038` | `GO:0000062` |
    +==============+==============+==============+
    | AT1G01010    | 0.512        | 0.228        |
    +--------------+--------------+--------------+
    | AT1G01030    | 0.427        | 0.219        |
    +--------------+--------------+--------------+
    | AT1G01040    | 0.432        | 0.174        |
    +--------------+--------------+--------------+


  * **User-specific** - select the **gene2function construction** and **gene description** generated through **Knowledge data** tool in the **History** panel, or upload these data on the same format


.. _SNPMapGene.R: https://github.com/cma2015/TAMF/blob/master/SNPMapGene.R


-------------


.. class:: infomark

**Outputs**

For **New candidates of a gene set**:

* **AUSR** - area under the curve of the self-ranked genes plot of the gene set through leave one out cross validation

* .. image:: static/AUSR.jpg
    :width: 500 px
    :scale: 50 %   
    :align: center

| 

* **new candidates** - the new candidates of the gene set

  +------+-----------+-------+----------------------------------------------------------------------------------------------------+
  | rank | geneName  | score | geneDescription                                                                                    |
  +======+===========+=======+====================================================================================================+
  | 1    | AT1G08380 | 1     | PSAO [Source:UniProtKB/TrEMBL;Acc:A0A178W5Y5]                                                      |
  +------+-----------+-------+----------------------------------------------------------------------------------------------------+
  | 2    | AT3G16140 | 0.996 | Photosystem I reaction center subunit VI-1, chloroplastic [Source:UniProtKB/Swiss-Prot;Acc:Q9SUI7] |
  +------+-----------+-------+----------------------------------------------------------------------------------------------------+
  | 3    | AT4G12800 | 0.985 | photosystem I subunit l [Source:TAIR;Acc:AT4G12800]                                                |
  +------+-----------+-------+----------------------------------------------------------------------------------------------------+

For **Biological interpretation of GWAS result**:

* **manhattan plot** - manhattan plot of the GWAS result

* .. image:: static/manha.jpg
    :width: 500 px
    :scale: 50 %   
    :align: center

| 

* **visulization of the filter** - heatmap of the significant genes above the significant level

* .. image:: static/GWAS_ph.jpg
   :width: 500 px
   :scale: 60 %   
   :align: center

|

* **enrichment analysis** - enrichment analysis of the significant genes above the significant level

  +--------------+-----------+-----------------------------------------------------------------------------+------------------------+
  | GO           | fdr       | function                                                                    | domain                 | 
  +==============+===========+=============================================================================+========================+
  | `GO:0008272` | 1.850e-03 | sulfate transport namespace: biological_process name: sulfate transport     | biological_process     |
  +--------------+-----------+-----------------------------------------------------------------------------+------------------------+
  | `GO:0010256` | 3.689e-03 | endomembrane system organization                                            | biological_processce   |
  +--------------+-----------+-----------------------------------------------------------------------------+------------------------+
  | `GO:0015116` | 1.202e-03 | sulfate transmembrane transporter activity                                  | molecular_function     |
  +--------------+-----------+-----------------------------------------------------------------------------+------------------------+
  | `GO:0015706` | 3.298e-04 | nitrate transport namespace: biological_process name: nitrate transport     | biological_process     |
  +--------------+-----------+-----------------------------------------------------------------------------+------------------------+

|

* **prioritize the potential genes** - prioritize the potential related genes below the significant level

  +-----------+----------------+-----+-------------------------------------------------------------------------------------------+
  | geneName  | -log10(pvalue) | fdr |  PCC  | description                                                                       |
  +===========+================+=====+=======+===================================================================================+
  | AT1G01750 | 1.793          | 0   | 0.631 |actin depolymerizing factor 11 [Source:TAIR;Acc:AT1G01750]                         |
  +-----------+----------------+-----+-------+-----------------------------------------------------------------------------------+
  | AT1G14780 | 2.453          | 0   | 0.587 |MACPF domain-containing protein At1g14780 [Source:UniProtKB/Swiss-Prot;Acc:Q8L612] |
  +-----------+----------------+-----+-------+-----------------------------------------------------------------------------------+ 
  | AT1G28960 | 1.002          |0    | 0.642 | NUDX15 [Source:UniProtKB/TrEMBL;Acc:A0A178WAX9]                                   |
  +-----------+----------------+-----+-------+-----------------------------------------------------------------------------------+

|

* **filter false related genes** - the high quality relevant genes after filtering the false related genes above the significant level

  +-----------+----------------------------------------------------------------------------------------------------+
  | geneName  | description                                                                                        |
  +===========+====================================================================================================+
  | AT1G11540 | Sulfite exporter TauE/SafE family protein [Source:TAIR;Acc:AT1G11540]                              |
  +-----------+----------------------------------------------------------------------------------------------------+
  | AT2G27120 | DNA polymerase epsilon catalytic subunit [Source:TAIR;Acc:AT2G27120]                               |
  +-----------+----------------------------------------------------------------------------------------------------+
  | AT2G30470 | B3 domain-containing transcription repressor VAL1 [Source:UniProtKB/Swiss-Prot;Acc:Q8W4L5]         |
  +-----------+----------------------------------------------------------------------------------------------------+

|


-------------

.. class:: warningmark

**Note**

* For **Biological interpretation of GWAS result**, the **functional gene probabilities construction** and **gene description** could be firstly generated through **Knowledge data** tool, then select these files in **History** panel.

* These knowledge files could be uploaded from personal generated only be kept the same format with example data through **Get Data** tool.


-------------

|


  </help>



</tool>
